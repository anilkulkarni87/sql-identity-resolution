# Chat Session Summary: December 30-31, 2024

## Session Overview

Comprehensive enhancement of the sql-identity-resolution system including new platform support, testing infrastructure, scale testing, and documentation.

---

## Major Accomplishments

### 1. New Platform Support

**BigQuery** (`sql/bigquery/`)
- `00_ddl_all.sql` — Schema and table definitions
- `idr_run.py` — Python runner with CLI arguments
- `idr_sample_data.sql` — Sample data generator
- `idr_sample_data.py` — Python sample data generator
- `idr_scale_test.py` — Scale testing (100K-10M rows)

**DuckDB** (`sql/duckdb/`)
- `00_ddl_all.sql` — Schema and table definitions
- `idr_run.py` — Python runner with CLI arguments
- `idr_sample_data.py` — Sample data generator
- `idr_scale_test.py` — Scale testing (100K-2M rows)

### 2. Scale Testing Infrastructure

Created scale test scripts for all 4 platforms:
| Platform | File | Scale Range |
|----------|------|-------------|
| Databricks | `sql/databricks/notebooks/IDR_ScaleTest.py` | 100K-10M |
| Snowflake | `sql/snowflake/IDR_ScaleTest.sql` | 100K-10M |
| BigQuery | `sql/bigquery/idr_scale_test.py` | 100K-10M |
| DuckDB | `sql/duckdb/idr_scale_test.py` | 100K-2M |

### 3. Documentation Created/Updated

| Document | Purpose |
|----------|---------|
| `docs/testing_databricks.md` | Step-by-step Databricks testing guide |
| `docs/testing_snowflake.md` | Step-by-step Snowflake testing guide |
| `docs/testing_bigquery.md` | Step-by-step BigQuery testing guide |
| `docs/testing_duckdb.md` | Step-by-step DuckDB testing guide |
| `docs/cluster_sizing.md` | Platform-specific sizing recommendations |
| `docs/architecture.md` | Updated with resolved_id design, rules documentation |
| `README.md` | Updated with 4-platform support matrix |

### 4. Bug Fixes

**Singleton Handling** — Entities without edges (no matching identifiers) were not being added to membership. Fixed in all runners:
- `sql/common/40_update_membership_current.sql` (Databricks)
- `sql/snowflake/IDR_Run.sql`
- `sql/bigquery/idr_run.py`
- `sql/duckdb/idr_run.py`

**Golden Profile Generation** — Added to Snowflake, BigQuery, and DuckDB runners (was only in Databricks).

---

## Key Design Decisions Documented

### resolved_id = MIN(entity_key)
- **Deterministic**: Same data → same result
- **Persistent**: Doesn't change between runs
- **Traceable**: Shows which entity "anchored" the cluster
- **Singletons**: Get `resolved_id = entity_key`

### Canonicalization Options
| Option | Effect |
|--------|--------|
| LOWERCASE | `John@Gmail.COM` → `john@gmail.com` |
| UPPERCASE | `john@gmail.com` → `JOHN@GMAIL.COM` |
| NONE | No transformation |
| TRIM | Remove whitespace |
| PHONE_DIGITS | Keep only digits |

---

## Useful Queries

**Find all entities in a cluster:**
```sql
SELECT m.resolved_id, m.entity_key, i.identifier_type, i.identifier_value_norm
FROM idr_out.identity_resolved_membership_current m
JOIN idr_work.identifiers_all i ON i.entity_key = m.entity_key
WHERE m.resolved_id = 'customer:C000003';
```

**Cluster size distribution:**
```sql
SELECT 
  CASE WHEN cluster_size = 1 THEN 'singleton'
       WHEN cluster_size <= 5 THEN 'small'
       ELSE 'large' END AS bucket,
  COUNT(*) AS clusters
FROM idr_out.identity_clusters_current
GROUP BY 1;
```

---

## Quick Start Commands

**DuckDB (local testing):**
```bash
cd sql/duckdb
duckdb idr.duckdb < 00_ddl_all.sql
python idr_sample_data.py --db=idr.duckdb --rows=2000
python idr_run.py --db=idr.duckdb --run-mode=FULL
```

**Scale testing:**
```bash
# DuckDB scale test
python idr_scale_test.py --db=scale.duckdb --scale=500K

# BigQuery scale test
python idr_scale_test.py --project=your-project --scale=1M
```

---

## Files Modified (complete list)

```
sql/bigquery/
├── 00_ddl_all.sql              [NEW]
├── idr_run.py                  [NEW]
├── idr_sample_data.sql         [NEW]
├── idr_sample_data.py          [NEW]
└── idr_scale_test.py           [NEW]

sql/duckdb/
├── 00_ddl_all.sql              [NEW]
├── idr_run.py                  [NEW]
├── idr_sample_data.py          [NEW]
└── idr_scale_test.py           [NEW]

sql/databricks/notebooks/
└── IDR_ScaleTest.py            [NEW]

sql/snowflake/
├── IDR_ScaleTest.sql           [NEW]
└── IDR_Run.sql                 [MODIFIED - golden profile + singletons]

sql/common/
└── 40_update_membership_current.sql  [MODIFIED - singletons]

docs/
├── testing_databricks.md       [NEW]
├── testing_snowflake.md        [NEW]
├── testing_bigquery.md         [NEW]
├── testing_duckdb.md           [NEW]
├── cluster_sizing.md           [NEW]
└── architecture.md             [MODIFIED - resolved_id, rules docs]

README.md                       [MODIFIED - platform matrix]
```

---

## Next Steps (discussed but not implemented)

1. **UI**: Discussed but recommended against for SQL-first project
2. **Scale testing execution**: Run benchmarks on each platform
3. **CI/CD with DuckDB**: Example GitHub Action in testing_duckdb.md
